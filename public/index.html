<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco Central Playground</title>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/themes/dark-unica.js"></script>
    <script src="https://code.highcharts.com/themes/gray.js"></script>
    
    <style>
        :root {
            /* Tema Escuro (Padr√£o) */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #21262d;
            --bg-hover: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #656d76;
            --border-color: #30363d;
            --accent-color: #238636;
            --accent-hover: #2ea043;
            --warning-color: #f85149;
            --info-color: #58a6ff;
            --success-color: #3fb950;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            /* Tema Claro */
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-card: #ffffff;
            --bg-hover: #f3f4f6;
            --text-primary: #24292f;
            --text-secondary: #656d76;
            --text-muted: #8b949e;
            --border-color: #d0d7de;
            --accent-color: #1f883d;
            --accent-hover: #1a7f37;
            --warning-color: #d1242f;
            --info-color: #0969da;
            --success-color: #1f883d;
            --shadow: 0 8px 24px rgba(31, 35, 40, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-color), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .section-title i {
            color: var(--accent-color);
            font-size: 1.3rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .data-display {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: var(--warning-color);
            background: rgba(248, 81, 73, 0.1);
            border-left-color: var(--warning-color);
        }

        .success {
            color: var(--success-color);
            background: rgba(63, 185, 80, 0.1);
            border-left-color: var(--success-color);
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            flex-shrink: 0;
            min-width: 80px;
            line-height: 1.4;
        }

        .metric-value {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            text-align: right;
            line-height: 1.4;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .metric-value.positive {
            color: var(--success-color);
        }

        .metric-value.negative {
            color: var(--warning-color);
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 4px;
            line-height: 1.2;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .stat-value.positive {
            color: var(--success-color);
        }

        .stat-value.negative {
            color: var(--warning-color);
        }

        .chart-container {
            margin-top: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            min-height: 300px;
        }

        .stats-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            min-width: 140px;
            flex: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.3;
        }

        .loading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--bg-secondary);
            z-index: 1000;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--info-color));
            width: 0%;
            transition: width 0.3s ease;
            animation: progressGlow 2s ease-in-out infinite;
        }

        @keyframes progressGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            box-shadow: var(--shadow);
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        .refresh-indicator {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 8px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .logo h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 16px;
            }

            .stats-row {
                flex-direction: column;
                gap: 8px;
            }

            .stat-card {
                min-width: auto;
            }

            .stat-value {
                font-size: 1.4rem;
            }

            .metric {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .metric-label {
                min-width: auto;
                font-size: 0.8rem;
            }

            .metric-value {
                text-align: left;
                font-size: 0.85rem;
            }
        }

        /* Anima√ß√µes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Barra de progresso de carregamento -->
    <div class="loading-progress" id="loading-progress" style="display: none;">
        <div class="loading-progress-bar" id="loading-progress-bar"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-university"></i>
                <h1>Banco Central Playground</h1>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon" id="theme-icon"></i>
                <span id="theme-text">Tema Claro</span>
            </button>
        </div>
    </header>

    <div class="container">
        <!-- Se√ß√£o C√¢mbio -->
        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-exchange-alt"></i>
                C√¢mbio
            </h2>
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-dollar-sign"></i>
                            PTAX - D√≥lar (USD)
                        </div>
                    </div>
                    <div id="ptax" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-euro-sign"></i>
                            PTAX - Euro (EUR)
                        </div>
                    </div>
                    <div id="ptax_euro" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o Infla√ß√£o e Juros -->
        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i>
                Infla√ß√£o e Juros
            </h2>
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-percentage"></i>
                            <span class="tooltip" data-tooltip="Taxa b√°sica de juros da economia">SELIC</span>
                        </div>
                    </div>
                    <div id="selic" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-area"></i>
                            <span class="tooltip" data-tooltip="√çndice de Pre√ßos ao Consumidor Amplo">IPCA</span>
                        </div>
                    </div>
                    <div id="ipca" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-line"></i>
                            <span class="tooltip" data-tooltip="Certificado de Dep√≥sito Interbanc√°rio">CDI - Hist√≥rico</span>
                        </div>
                    </div>
                    <div id="cdi" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                    <div id="grafico_cdi" class="chart-container" style="display: none;"></div>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o PIB -->
        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-chart-bar"></i>
                PIB - Produto Interno Bruto
            </h2>
            <div class="grid">
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-trophy"></i>
                            <span class="tooltip" data-tooltip="Principal indicador da atividade econ√¥mica nacional">PIB Trimestral</span>
                        </div>
                    </div>
                    <div id="pib" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                    <div id="grafico_pib" class="chart-container" style="display: none;"></div>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o Atividade Econ√¥mica -->
        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-chart-area"></i>
                Atividade Econ√¥mica
            </h2>
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-industry"></i>
                            <span class="tooltip" data-tooltip="Indicador mensal contempor√¢neo da atividade econ√¥mica nacional">IBC-Br</span>
                        </div>
                    </div>
                    <div id="ibc_br" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-balance-scale"></i>
                            <span class="tooltip" data-tooltip="Saldo da balan√ßa comercial brasileira">Balan√ßa Comercial</span>
                        </div>
                    </div>
                    <div id="balanca_comercial" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o Investimentos -->
        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-piggy-bank"></i>
                Investimentos Populares
            </h2>
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-university"></i>
                            <span class="tooltip" data-tooltip="Rendimento da caderneta de poupan√ßa">Poupan√ßa</span>
                        </div>
                    </div>
                    <div id="poupanca" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-line"></i>
                            <span class="tooltip" data-tooltip="Compara√ß√£o: Poupan√ßa vs SELIC vs CDI">Comparativo</span>
                        </div>
                    </div>
                    <div id="comparativo_investimentos" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o Cr√©dito -->
        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-credit-card"></i>
                Cr√©dito
            </h2>
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-shopping-cart"></i>
                            Taxa de Juros - Cr√©dito Consumo
                        </div>
                    </div>
                    <div id="credito" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-wallet"></i>
                            Carteira de Cr√©dito Total
                        </div>
                    </div>
                    <div id="carteira" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="tooltip" data-tooltip="Percentual da carteira com atraso superior a 90 dias">Taxa de Inadimpl√™ncia</span>
                        </div>
                    </div>
                    <div id="inadimplencia" class="data-display">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando dados...
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Detectar automaticamente a URL do proxy
        const getProxyUrl = () => {
            const currentHost = window.location.hostname;
            const currentProtocol = window.location.protocol;
            
            // Se estamos no Vercel (vercel.app domain) ou em produ√ß√£o
            if (currentHost.includes('vercel.app') || 
                (currentHost !== 'localhost' && currentHost !== '127.0.0.1')) {
                // Usar Vercel Serverless Function
                return `${currentProtocol}//${currentHost}/api/proxy?url=`;
            }
            
            // Se estamos acessando via localhost na porta 3000, usar a mesma
            if (window.location.port === '3000') {
                return `${currentProtocol}//${currentHost}:3000/proxy?url=`;
            }
            
            // Caso contr√°rio, assumir que o proxy est√° na porta 3000 (desenvolvimento)
            return `${currentProtocol}//${currentHost}:3000/proxy?url=`;
        };

        const proxyUrl = getProxyUrl();
        let currentTheme = 'dark';

        // Sistema de temas
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (currentTheme === 'dark') {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Tema Claro';
                if (window.Highcharts) {
                    Highcharts.setOptions(Highcharts.theme);
                }
            } else {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Tema Escuro';
                if (window.Highcharts) {
                    Highcharts.setOptions({});
                }
            }
            
            localStorage.setItem('bc-theme', currentTheme);
            
            // Atualizar gr√°ficos se existirem
            const chartContainer = document.getElementById('grafico_cdi');
            if (chartContainer && chartContainer.style.display !== 'none') {
                // Re-render chart with new theme
                setTimeout(() => fetchCDI(), 100);
            }
        }

        // Carregar tema salvo
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('bc-theme');
            if (savedTheme && savedTheme !== currentTheme) {
                toggleTheme();
            }
        }

        // Utilit√°rios
        function getUltimoDiaUtil() {
            const hoje = new Date();
            const diaSemana = hoje.getDay();
            if (diaSemana === 0) { hoje.setDate(hoje.getDate() - 2); }
            else if (diaSemana === 6) { hoje.setDate(hoje.getDate() - 1); }
            const mm = String(hoje.getMonth() + 1).padStart(2, '0');
            const dd = String(hoje.getDate()).padStart(2, '0');
            const yyyy = hoje.getFullYear();
            return `${mm}-${dd}-${yyyy}`;
        }

        function formatCurrency(value, currency = 'BRL') {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return 'N/A';
            
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 4
            }).format(numValue);
        }

        function formatPercentage(value, decimals = 2) {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return 'N/A';
            
            return new Intl.NumberFormat('pt-BR', {
                style: 'percent',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(numValue / 100);
        }

        function formatDate(dateStr) {
            try {
                // Verificar se a data est√° no formato DD/MM/YYYY
                if (dateStr && dateStr.includes('/')) {
                    const [day, month, year] = dateStr.split('/');
                    if (day && month && year && day.length <= 2 && month.length <= 2 && year.length === 4) {
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            return date.toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                        }
                    }
                }
                
                // Tentar parsing de outros formatos
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                }
                
                // Se n√£o conseguir parsear, retornar a string original
                return dateStr || 'Data n√£o dispon√≠vel';
            } catch (error) {
                console.warn('Erro ao formatar data:', dateStr, error);
                return dateStr || 'Data n√£o dispon√≠vel';
            }
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            
            element.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Carregando dados...
                </div>
            `;
            element.className = 'data-display';
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            
            element.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
                <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                    <i class="fas fa-info-circle"></i>
                    Recarregue a p√°gina para tentar novamente
                </div>
            `;
            element.className = 'data-display error';
        }

        function showSuccess(elementId, content) {
            const element = document.getElementById(elementId);
            
            element.innerHTML = content;
            element.className = 'data-display success fade-in';
            
            // Adicionar timestamp de atualiza√ß√£o
            const refreshIndicator = document.createElement('div');
            refreshIndicator.className = 'refresh-indicator';
            refreshIndicator.innerHTML = `<i class="fas fa-clock"></i> Atualizado em ${new Date().toLocaleTimeString('pt-BR')}`;
            element.parentNode.appendChild(refreshIndicator);
        }

        // Fun√ß√µes de API melhoradas
        async function checkProxyHealth() {
            try {
                // Para Vercel, verificar usando o endpoint de health
                if (proxyUrl.includes('/api/proxy')) {
                    const healthUrl = proxyUrl.replace('?url=', '?health=true');
                    const response = await fetch(healthUrl);
                    return response.ok;
                } else {
                    // Para desenvolvimento local
                    const healthUrl = proxyUrl.replace('/proxy?url=', '/health');
                    const response = await fetch(healthUrl);
                    return response.ok;
                }
            } catch {
                return false;
            }
        }

        async function fetchWithProxy(url, elementId) {
            try {
                showLoading(elementId);
                
                // Verificar se o proxy est√° funcionando
                const proxyHealthy = await checkProxyHealth();
                if (!proxyHealthy) {
                    throw new Error('Servidor proxy n√£o est√° dispon√≠vel.');
                }
                
                const proxyRequestUrl = proxyUrl + encodeURIComponent(url);
                console.log(`üîó Fazendo requisi√ß√£o via proxy: ${proxyRequestUrl}`);
                
                const response = await fetch(proxyRequestUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    // Timeout de 25 segundos
                    signal: AbortSignal.timeout(25000)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log(`üìä Resposta para ${elementId}:`, result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Erro desconhecido do servidor');
                }
                
                return result.data;
            } catch (error) {
                console.error(`‚ùå Erro na requisi√ß√£o para ${elementId}:`, error);
                let errorMessage = `Erro: ${error.message}`;
                if (error.name === 'AbortError') {
                    errorMessage = 'Timeout: API demorou para responder';
                }
                showError(elementId, errorMessage);
                throw error;
            }
        }

        async function fetchPTAX() {
            const dataFormatada = getUltimoDiaUtil();
            const apiUrl = `https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarDia(dataCotacao=@dataCotacao)?@dataCotacao='${dataFormatada}'&$top=1&$format=json`;
            
            try {
                const data = await fetchWithProxy(apiUrl, 'ptax');
                
                if (data.value && data.value.length > 0) {
                    const cotacao = data.value[0];
                    
                    // Melhor tratamento da data - usar a data formatada que enviamos na requisi√ß√£o
                    const dataExibicao = dataFormatada.split('-').reverse().join('/'); // MM-DD-YYYY -> DD/MM/YYYY
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${formatCurrency(cotacao.cotacaoCompra, 'USD')}</div>
                                <div class="stat-label">Compra</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${formatCurrency(cotacao.cotacaoVenda, 'USD')}</div>
                                <div class="stat-label">Venda</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${dataExibicao}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Cota√ß√£o oficial do d√≥lar</span>
                        </div>
                    `;
                    showSuccess('ptax', content);
                } else {
                    showError('ptax', 'Nenhum dado encontrado para a data especificada');
                }
            } catch (error) {
                console.error('Erro PTAX:', error);
            }
        }

        async function fetchPTAXEuro() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.21620/dados/ultimos/1?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'ptax_euro');
                
                if (data && data.length > 0) {
                    const cotacao = data[0];
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${formatCurrency(parseFloat(cotacao.valor), 'EUR')}</div>
                                <div class="stat-label">Cota√ß√£o Euro</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(cotacao.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Cota√ß√£o oficial do euro</span>
                        </div>
                    `;
                    showSuccess('ptax_euro', content);
                } else {
                    showError('ptax_euro', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro PTAX Euro:', error);
            }
        }

        async function fetchSELIC() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.11/dados/ultimos/1?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'selic');
                
                if (data && data.length > 0) {
                    const selic = data[0];
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${formatPercentage(parseFloat(selic.valor))}</div>
                                <div class="stat-label">Taxa SELIC</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(selic.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Taxa b√°sica da economia</span>
                        </div>
                    `;
                    showSuccess('selic', content);
                } else {
                    showError('selic', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro SELIC:', error);
            }
        }

        async function fetchIPCA() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados/ultimos/1?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'ipca');
                
                if (data && data.length > 0) {
                    const ipca = data[0];
                    const valor = parseFloat(ipca.valor);
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${formatPercentage(valor)}</div>
                                <div class="stat-label">IPCA Mensal</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(ipca.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Infla√ß√£o oficial do pa√≠s</span>
                        </div>
                    `;
                    showSuccess('ipca', content);
                } else {
                    showError('ipca', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro IPCA:', error);
            }
        }

        async function fetchCDI() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados/ultimos/20?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'cdi');
                
                if (data && data.length > 0) {
                    const ultimoCDI = data[data.length - 1];
                    const valor = parseFloat(ultimoCDI.valor);
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${formatPercentage(valor)}</div>
                                <div class="stat-label">CDI Atual</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.length}</div>
                                <div class="stat-label">Registros</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">√öltima Data:</span>
                            <span class="metric-value">${formatDate(ultimoCDI.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Refer√™ncia para investimentos</span>
                        </div>
                    `;
                    
                    showSuccess('cdi', content);

                    // Preparar dados para o gr√°fico
                    const categorias = data.map(item => {
                        const [day, month, year] = item.data.split('/');
                        return `${day}/${month}`;
                    });
                    const valores = data.map(item => parseFloat(item.valor));

                    // Mostrar container do gr√°fico
                    const chartContainer = document.getElementById('grafico_cdi');
                    chartContainer.style.display = 'block';

                    // Configurar tema do gr√°fico
                    const isDark = currentTheme === 'dark';
                    
                    Highcharts.chart('grafico_cdi', {
                        accessibility: {
                            enabled: false
                        },
                        chart: {
                            type: 'line',
                            backgroundColor: isDark ? '#161b22' : '#ffffff',
                        },
                        title: {
                            text: 'CDI - √öltimos 20 Registros',
                            style: {
                                color: isDark ? '#e6edf3' : '#24292f'
                            }
                        },
                        xAxis: {
                            categories: categorias,
                            labels: {
                                style: {
                                    color: isDark ? '#8b949e' : '#656d76'
                                }
                            }
                        },
                        yAxis: {
                            title: {
                                text: '% ao ano',
                                style: {
                                    color: isDark ? '#e6edf3' : '#24292f'
                                }
                            },
                            labels: {
                                style: {
                                    color: isDark ? '#8b949e' : '#656d76'
                                }
                            }
                        },
                        series: [{
                            name: 'CDI',
                            data: valores,
                            color: '#58a6ff',
                            lineWidth: 3,
                            marker: {
                                radius: 4
                            }
                        }],
                        legend: {
                            itemStyle: {
                                color: isDark ? '#e6edf3' : '#24292f'
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? '#21262d' : '#ffffff',
                            style: {
                                color: isDark ? '#e6edf3' : '#24292f'
                            },
                            formatter: function() {
                                return `<b>${this.series.name}</b><br/>Data: ${this.x}<br/>Taxa: ${this.y.toFixed(2)}% a.a.`;
                            }
                        }
                    });
                } else {
                    showError('cdi', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro CDI:', error);
            }
        }

        async function fetchCredito() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.7456/dados/ultimos/1?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'credito');
                
                if (data && data.length > 0) {
                    const credito = data[0];
                    const valor = parseFloat(credito.valor);
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${formatPercentage(valor)}</div>
                                <div class="stat-label">Taxa de Juros</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(credito.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Custo do cr√©dito ao consumo</span>
                        </div>
                    `;
                    showSuccess('credito', content);
                } else {
                    showError('credito', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro Cr√©dito:', error);
            }
        }

        async function fetchCarteira() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.20727/dados/ultimos/1?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'carteira');
                
                if (data && data.length > 0) {
                    const carteira = data[0];
                    const valor = parseFloat(carteira.valor);
                    const valorFormatado = new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(valor * 1000000); // Converter de milh√µes para reais
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${valorFormatado}</div>
                                <div class="stat-label">Carteira Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${valor.toFixed(0)} bi</div>
                                <div class="stat-label">Em Bilh√µes</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(carteira.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Volume total de cr√©dito</span>
                        </div>
                    `;
                    showSuccess('carteira', content);
                } else {
                    showError('carteira', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro Carteira:', error);
            }
        }

        // Fun√ß√£o para mostrar/ocultar barra de progresso
        function showProgressBar() {
            const progressContainer = document.getElementById('loading-progress');
            const progressBar = document.getElementById('loading-progress-bar');
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('loading-progress-bar');
            progressBar.style.width = percentage + '%';
        }

        function hideProgressBar() {
            const progressContainer = document.getElementById('loading-progress');
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 500);
        }

        // Fun√ß√£o para buscar dados do PIB
        async function fetchPIB() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.4385/dados/ultimos/8?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'pib');
                
                if (data && data.length > 0) {
                    const latest = data[data.length - 1];
                    const valor = parseFloat(latest.valor);
                    
                    // Calcular varia√ß√£o trimestral e anual
                    let variacaoTrimestral = null;
                    let variacaoAnual = null;
                    
                    if (data.length > 1) {
                        const anterior = parseFloat(data[data.length - 2].valor);
                        variacaoTrimestral = ((valor - anterior) / anterior * 100).toFixed(2);
                    }
                    
                    if (data.length >= 4) {
                        const anoAnterior = parseFloat(data[data.length - 5].valor);
                        variacaoAnual = ((valor - anoAnterior) / anoAnterior * 100).toFixed(2);
                    }
                    
                    // Determinar status da economia
                    let statusEconomia = 'Est√°vel';
                    let classeStatus = '';
                    if (variacaoTrimestral && parseFloat(variacaoTrimestral) > 0.5) {
                        statusEconomia = 'Crescimento';
                        classeStatus = 'positive';
                    } else if (variacaoTrimestral && parseFloat(variacaoTrimestral) < -0.5) {
                        statusEconomia = 'Retra√ß√£o';
                        classeStatus = 'negative';
                    }
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${valor.toFixed(2)}</div>
                                <div class="stat-label">√çndice Base</div>
                            </div>
                            ${variacaoTrimestral !== null ? `
                            <div class="stat-card">
                                <div class="stat-value ${parseFloat(variacaoTrimestral) >= 0 ? 'positive' : 'negative'}">${parseFloat(variacaoTrimestral) >= 0 ? '+' : ''}${variacaoTrimestral}%</div>
                                <div class="stat-label">Varia√ß√£o Trimestral</div>
                            </div>
                            ` : ''}
                            ${variacaoAnual !== null ? `
                            <div class="stat-card">
                                <div class="stat-value ${parseFloat(variacaoAnual) >= 0 ? 'positive' : 'negative'}">${parseFloat(variacaoAnual) >= 0 ? '+' : ''}${variacaoAnual}%</div>
                                <div class="stat-label">Varia√ß√£o Anual</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="metric">
                            <span class="metric-label">Status:</span>
                            <span class="metric-value ${classeStatus}">${statusEconomia}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Per√≠odo:</span>
                            <span class="metric-value">${formatDate(latest.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Principal indicador da economia nacional</span>
                        </div>
                    `;
                    showSuccess('pib', content);

                    // Preparar dados para o gr√°fico (√∫ltimos 8 trimestres)
                    const categorias = data.map(item => {
                        // Converter formato de data para trimestre
                        const [day, month, year] = item.data.split('/');
                        const trimestre = Math.ceil(parseInt(month) / 3);
                        return `${trimestre}T${year}`;
                    });
                    
                    const valores = data.map(item => parseFloat(item.valor));
                    
                    // Calcular varia√ß√µes trimestrais para o gr√°fico
                    const variacoes = [];
                    for (let i = 1; i < valores.length; i++) {
                        const variacao = ((valores[i] - valores[i-1]) / valores[i-1] * 100);
                        variacoes.push(variacao);
                    }

                    // Mostrar container do gr√°fico
                    const chartContainer = document.getElementById('grafico_pib');
                    chartContainer.style.display = 'block';

                    // Configurar tema do gr√°fico
                    const isDark = currentTheme === 'dark';
                    
                    Highcharts.chart('grafico_pib', {
                        accessibility: {
                            enabled: false
                        },
                        chart: {
                            type: 'combination',
                            backgroundColor: isDark ? '#161b22' : '#ffffff',
                        },
                        title: {
                            text: 'PIB - Evolu√ß√£o e Varia√ß√£o Trimestral',
                            style: {
                                color: isDark ? '#e6edf3' : '#24292f'
                            }
                        },
                        xAxis: {
                            categories: categorias,
                            labels: {
                                style: {
                                    color: isDark ? '#8b949e' : '#656d76'
                                }
                            }
                        },
                        yAxis: [{
                            title: {
                                text: '√çndice PIB',
                                style: {
                                    color: isDark ? '#e6edf3' : '#24292f'
                                }
                            },
                            labels: {
                                style: {
                                    color: isDark ? '#8b949e' : '#656d76'
                                }
                            }
                        }, {
                            title: {
                                text: 'Varia√ß√£o Trimestral (%)',
                                style: {
                                    color: isDark ? '#e6edf3' : '#24292f'
                                }
                            },
                            labels: {
                                style: {
                                    color: isDark ? '#8b949e' : '#656d76'
                                }
                            },
                            opposite: true
                        }],
                        series: [{
                            name: 'PIB (√çndice)',
                            type: 'line',
                            data: valores,
                            color: '#58a6ff',
                            lineWidth: 3,
                            marker: {
                                radius: 5
                            },
                            yAxis: 0
                        }, {
                            name: 'Varia√ß√£o Trimestral (%)',
                            type: 'column',
                            data: variacoes,
                            color: '#3fb950',
                            yAxis: 1,
                            zones: [{
                                value: 0,
                                color: '#f85149'
                            }, {
                                color: '#3fb950'
                            }]
                        }],
                        legend: {
                            itemStyle: {
                                color: isDark ? '#e6edf3' : '#24292f'
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? '#21262d' : '#ffffff',
                            style: {
                                color: isDark ? '#e6edf3' : '#24292f'
                            },
                            shared: true,
                            formatter: function() {
                                let tooltip = `<b>${this.x}</b>`;
                                this.points.forEach(point => {
                                    if (point.series.name.includes('Varia√ß√£o')) {
                                        tooltip += `<br/>${point.series.name}: ${point.y.toFixed(2)}%`;
                                    } else {
                                        tooltip += `<br/>${point.series.name}: ${point.y.toFixed(2)}`;
                                    }
                                });
                                return tooltip;
                            }
                        }
                    });
                } else {
                    showError('pib', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro PIB:', error);
            }
        }

        // Fun√ß√£o para buscar dados do IBC-Br (√çndice de Atividade Econ√¥mica)
        async function fetchIBCBr() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.24363/dados/ultimos/2?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'ibc_br');
                
                if (data && data.length > 0) {
                    const latest = data[data.length - 1];
                    const valor = parseFloat(latest.valor);
                    
                    // Calcular varia√ß√£o se temos dados suficientes
                    let variacao = null;
                    if (data.length > 1) {
                        const anterior = parseFloat(data[data.length - 2].valor);
                        variacao = ((valor - anterior) / anterior * 100).toFixed(2);
                    }
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${valor.toFixed(2)}</div>
                                <div class="stat-label">√çndice</div>
                            </div>
                            ${variacao !== null ? `
                            <div class="stat-card">
                                <div class="stat-value ${parseFloat(variacao) >= 0 ? 'positive' : 'negative'}">${parseFloat(variacao) >= 0 ? '+' : ''}${variacao}%</div>
                                <div class="stat-label">Varia√ß√£o Mensal</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(latest.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Indicador proxy do PIB mensal</span>
                        </div>
                    `;
                    showSuccess('ibc_br', content);
                } else {
                    showError('ibc_br', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro IBC-Br:', error);
            }
        }

        // Fun√ß√£o para buscar dados da Balan√ßa Comercial
        async function fetchBalancaComercial() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.22707/dados/ultimos/2?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'balanca_comercial');
                
                if (data && data.length > 0) {
                    const latest = data[data.length - 1];
                    const valor = parseFloat(latest.valor);
                    
                    // Calcular varia√ß√£o se temos dados suficientes
                    let variacao = null;
                    if (data.length > 1) {
                        const anterior = parseFloat(data[data.length - 2].valor);
                        variacao = valor - anterior;
                    }
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value ${valor >= 0 ? 'positive' : 'negative'}">US$ ${formatNumber(valor)}</div>
                                <div class="stat-label">Saldo (Milh√µes)</div>
                            </div>
                            ${variacao !== null ? `
                            <div class="stat-card">
                                <div class="stat-value ${variacao >= 0 ? 'positive' : 'negative'}">${variacao >= 0 ? '+' : ''}US$ ${formatNumber(variacao)}</div>
                                <div class="stat-label">Varia√ß√£o Mensal</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(latest.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Competitividade externa do pa√≠s</span>
                        </div>
                    `;
                    showSuccess('balanca_comercial', content);
                } else {
                    showError('balanca_comercial', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro Balan√ßa Comercial:', error);
            }
        }

        // Fun√ß√£o para buscar dados da Poupan√ßa
        async function fetchPoupanca() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.195/dados/ultimos/3?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'poupanca');
                
                if (data && data.length > 0) {
                    const latest = data[data.length - 1];
                    const valor = parseFloat(latest.valor);
                    
                    // Calcular varia√ß√£o mensal se temos dados suficientes
                    let variacaoMensal = null;
                    if (data.length > 1) {
                        const anterior = parseFloat(data[data.length - 2].valor);
                        variacaoMensal = (valor - anterior).toFixed(4);
                    }
                    
                    // Calcular rendimento anualizado (aproximado)
                    const rendimentoAnual = (Math.pow(1 + valor/100, 12) - 1) * 100;
                    
                    // Simular valor em R$ 10.000 investidos
                    const simulacao10k = 10000 * (valor / 100);
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value">${formatPercentage(valor)}</div>
                                <div class="stat-label">Rendimento Mensal</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${rendimentoAnual.toFixed(2)}%</div>
                                <div class="stat-label">Anualizado (aprox)</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Simula√ß√£o R$ 10.000:</span>
                            <span class="metric-value positive">+${formatCurrency(simulacao10k).replace('R$', 'R$').trim()}/m√™s</span>
                        </div>
                        ${variacaoMensal !== null ? `
                        <div class="metric">
                            <span class="metric-label">Varia√ß√£o:</span>
                            <span class="metric-value ${parseFloat(variacaoMensal) >= 0 ? 'positive' : 'negative'}">${parseFloat(variacaoMensal) >= 0 ? '+' : ''}${variacaoMensal} p.p.</span>
                        </div>
                        ` : ''}
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(latest.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Vantagem:</span>
                            <span class="metric-value">Liquidez di√°ria + garantia</span>
                        </div>
                    `;
                    showSuccess('poupanca', content);
                } else {
                    showError('poupanca', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro Poupan√ßa:', error);
            }
        }

        // Fun√ß√£o para criar comparativo entre investimentos
        async function fetchComparativoInvestimentos() {
            try {
                showLoading('comparativo_investimentos');
                
                console.log('üîó Carregando dados para comparativo...');
                
                // Fazer requisi√ß√µes diretas sem usar fetchWithProxy (que espera elementos DOM)
                const proxyRequestUrl1 = proxyUrl + encodeURIComponent("https://api.bcb.gov.br/dados/serie/bcdata.sgs.195/dados/ultimos/1?formato=json");
                const proxyRequestUrl2 = proxyUrl + encodeURIComponent("https://api.bcb.gov.br/dados/serie/bcdata.sgs.11/dados/ultimos/1?formato=json");
                const proxyRequestUrl3 = proxyUrl + encodeURIComponent("https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados/ultimos/1?formato=json");
                
                const [response1, response2, response3] = await Promise.all([
                    fetch(proxyRequestUrl1),
                    fetch(proxyRequestUrl2),
                    fetch(proxyRequestUrl3)
                ]);
                
                const result1 = await response1.json();
                const result2 = await response2.json();
                const result3 = await response3.json();
                
                const poupancaData = result1.success ? result1.data : null;
                const selicData = result2.success ? result2.data : null;
                const cdiData = result3.success ? result3.data : null;
                
                if (poupancaData && selicData && cdiData && 
                    poupancaData.length > 0 && selicData.length > 0 && cdiData.length > 0) {
                    
                    const poupanca = parseFloat(poupancaData[0].valor);
                    const selic = parseFloat(selicData[0].valor);
                    const cdi = parseFloat(cdiData[0].valor);
                    
                    console.log('üìä Dados do comparativo:', { poupanca, selic, cdi });
                    
                    // Calcular rendimentos anualizados aproximados
                    const poupancaAnual = (Math.pow(1 + poupanca/100, 12) - 1) * 100;
                    const selicAnual = selic;
                    const cdiAnual = cdi;
                    
                    // Simula√ß√£o com R$ 10.000
                    const simPoupanca = 10000 * (poupancaAnual / 100);
                    const simSelic = 10000 * (selicAnual / 100);
                    const simCDI = 10000 * (cdiAnual / 100);
                    
                    // Determinar o melhor investimento
                    let melhor = 'CDI';
                    let melhorValor = cdiAnual;
                    if (selicAnual > melhorValor) {
                        melhor = 'SELIC';
                        melhorValor = selicAnual;
                    }
                    if (poupancaAnual > melhorValor) {
                        melhor = 'Poupan√ßa';
                        melhorValor = poupancaAnual;
                    }
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value ${melhor === 'Poupan√ßa' ? 'positive' : ''}">${poupancaAnual.toFixed(2)}%</div>
                                <div class="stat-label">Poupan√ßa</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value ${melhor === 'SELIC' ? 'positive' : ''}">${selicAnual.toFixed(2)}%</div>
                                <div class="stat-label">SELIC</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value ${melhor === 'CDI' ? 'positive' : ''}">${cdiAnual.toFixed(2)}%</div>
                                <div class="stat-label">CDI</div>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Melhor op√ß√£o:</span>
                            <span class="metric-value positive">${melhor} (${melhorValor.toFixed(2)}% a.a.)</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Simula√ß√£o R$ 10.000/ano:</span>
                            <span class="metric-value">Poupan√ßa: +${formatCurrency(simPoupanca).replace('R$', 'R$').trim()}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label"></span>
                            <span class="metric-value">SELIC: +${formatCurrency(simSelic).replace('R$', 'R$').trim()}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label"></span>
                            <span class="metric-value">CDI: +${formatCurrency(simCDI).replace('R$', 'R$').trim()}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Observa√ß√£o:</span>
                            <span class="metric-value">Valores aproximados, sem impostos</span>
                        </div>
                    `;
                    showSuccess('comparativo_investimentos', content);
                } else {
                    console.error('‚ùå Dados incompletos para comparativo:', { poupancaData, selicData, cdiData });
                    showError('comparativo_investimentos', 'Erro ao carregar dados para compara√ß√£o');
                }
            } catch (error) {
                console.error('‚ùå Erro Comparativo:', error);
                showError('comparativo_investimentos', `Erro no comparativo: ${error.message}`);
            }
        }

        // Fun√ß√£o para buscar dados da Taxa de Inadimpl√™ncia
        async function fetchInadimplencia() {
            const apiUrl = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.21082/dados/ultimos/2?formato=json";
            
            try {
                const data = await fetchWithProxy(apiUrl, 'inadimplencia');
                
                if (data && data.length > 0) {
                    const latest = data[data.length - 1];
                    const valor = parseFloat(latest.valor);
                    
                    // Calcular varia√ß√£o se temos dados suficientes
                    let variacao = null;
                    if (data.length > 1) {
                        const anterior = parseFloat(data[data.length - 2].valor);
                        variacao = (valor - anterior).toFixed(2);
                    }
                    
                    // Determinar n√≠vel de risco
                    let nivelRisco = 'Moderado';
                    let classeRisco = '';
                    if (valor > 5) {
                        nivelRisco = 'Alto';
                        classeRisco = 'negative';
                    } else if (valor < 3) {
                        nivelRisco = 'Baixo';
                        classeRisco = 'positive';
                    }
                    
                    const content = `
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value ${classeRisco}">${valor.toFixed(2)}%</div>
                                <div class="stat-label">Taxa de Inadimpl√™ncia</div>
                            </div>
                            ${variacao !== null ? `
                            <div class="stat-card">
                                <div class="stat-value ${parseFloat(variacao) <= 0 ? 'positive' : 'negative'}">${parseFloat(variacao) >= 0 ? '+' : ''}${variacao} p.p.</div>
                                <div class="stat-label">Varia√ß√£o Mensal</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="metric">
                            <span class="metric-label">N√≠vel:</span>
                            <span class="metric-value ${classeRisco}">${nivelRisco}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Data:</span>
                            <span class="metric-value">${formatDate(latest.data)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Impacto:</span>
                            <span class="metric-value">Qualidade da carteira de cr√©dito</span>
                        </div>
                    `;
                    showSuccess('inadimplencia', content);
                } else {
                    showError('inadimplencia', 'Nenhum dado encontrado');
                }
            } catch (error) {
                console.error('Erro Taxa de Inadimpl√™ncia:', error);
            }
        }

        // Fun√ß√£o para carregar todos os dados automaticamente
        async function loadAllData() {
            console.log('üöÄ Carregando todos os dados automaticamente...');
            
            showProgressBar();
            let completed = 0;
            const total = 13; // N√∫mero total de APIs (incluindo Poupan√ßa e Comparativo)
            
            const updateProgressAndComplete = () => {
                completed++;
                const percentage = (completed / total) * 100;
                updateProgress(percentage);
                
                if (completed === total) {
                    setTimeout(() => {
                        hideProgressBar();
                        console.log('‚úÖ Carregamento inicial conclu√≠do');
                    }, 300);
                }
            };
            
            // Fun√ß√£o helper para executar fetch com atualiza√ß√£o de progresso
            const fetchWithProgress = async (fetchFunction) => {
                try {
                    await fetchFunction();
                } catch (error) {
                    console.error('Erro em uma das requisi√ß√µes:', error);
                } finally {
                    updateProgressAndComplete();
                }
            };
            
            // Carregar dados com pequeno delay entre as requisi√ß√µes para evitar sobrecarga
            setTimeout(() => fetchWithProgress(fetchPTAX), 100);
            setTimeout(() => fetchWithProgress(fetchPTAXEuro), 300);
            setTimeout(() => fetchWithProgress(fetchSELIC), 500);
            setTimeout(() => fetchWithProgress(fetchIPCA), 700);
            setTimeout(() => fetchWithProgress(fetchCDI), 900);
            setTimeout(() => fetchWithProgress(fetchPIB), 1100);
            setTimeout(() => fetchWithProgress(fetchIBCBr), 1300);
            setTimeout(() => fetchWithProgress(fetchBalancaComercial), 1500);
            setTimeout(() => fetchWithProgress(fetchPoupanca), 1700);
            setTimeout(() => fetchWithProgress(fetchComparativoInvestimentos), 1900);
            setTimeout(() => fetchWithProgress(fetchCredito), 2100);
            setTimeout(() => fetchWithProgress(fetchCarteira), 2300);
            setTimeout(() => fetchWithProgress(fetchInadimplencia), 2500);
        }

        // Fun√ß√£o para formatar n√∫meros grandes
        function formatNumber(num) {
            if (Math.abs(num) >= 1000) {
                return new Intl.NumberFormat('pt-BR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 1
                }).format(num);
            }
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(num);
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTheme();
            
            // Debug: mostrar URL do proxy sendo usada
            console.log('üîó Proxy URL configurada:', proxyUrl);
            console.log('üåê Acessando de:', window.location.href);
            
            // Verificar se o proxy est√° funcionando e carregar dados
            checkProxyHealth().then(healthy => {
                if (healthy) {
                    console.log('‚úÖ Proxy est√° funcionando');
                    // Carregar todos os dados automaticamente ap√≥s verificar o proxy
                    setTimeout(loadAllData, 500); // Pequeno delay para garantir que a p√°gina carregou
                } else {
                    console.warn('‚ö†Ô∏è Proxy n√£o est√° respondendo. Verifique se o servidor est√° rodando.');
                    
                    // Mostrar alerta visual se o proxy n√£o estiver funcionando
                    const alertDiv = document.createElement('div');
                    alertDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: var(--warning-color);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: var(--shadow);
                        z-index: 1000;
                        font-weight: 500;
                    `;
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        Servidor proxy n√£o est√° dispon√≠vel. Execute: npm start
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // Remover o alerta ap√≥s 10 segundos
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 10000);
                }
            });
            
            // Remover indicadores de refresh antigos (n√£o precisamos mais desta funcionalidade)
        });
    </script>
</body>
</html>
